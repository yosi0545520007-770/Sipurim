import{r as u,s as R,j as t,l as oe,h as G,H as I,i as ce,k as ie}from"./index-BaQbnNW9.js";import{D as de}from"./react-datepicker-DZsISyGV.js";import"./clsx-B-dksMZM.js";function Y(a){try{if(!a)return"";const s=typeof a=="string"?new Date(a):a;return isNaN(s.getTime())?"":new I(s).renderGematriya()}catch{return""}}function ue(a){try{return(a||"").normalize("NFD").replace(/[\u0591-\u05C7]/g,"").normalize("NFC")}catch{return a||""}}function q(a){return ue(String(a||"")).replace(/["'״׳]/g,"").replace(/\s+/g," ").trim()}function U(a){const s=q(a);if(!s)return null;const m=new Date,g=m.getFullYear()-5,x=m.getFullYear()+2;for(let n=g;n<=x;n++){const h=new Date(n,0,1);for(;h.getFullYear()===n;){const b=q(Y(h));if(b&&b===s)return new Date(h.getFullYear(),h.getMonth(),h.getDate());h.setDate(h.getDate()+1)}}return null}function o(a){let s=String(a??"").trim();return s=s.replace(/^\s*\[\s*"(.*)"\s*\]\s*$/s,"$1"),s=s.replace(/^["'\[\]]+|["'\[\]]+$/g,""),s=s.replace(/\s+/g," ").trim(),s}function he(a){const s=new I(a),m=s.getMonthName("he"),g=s.getFullYear(),x=new Intl.NumberFormat("he-IL-u-nu-hebr",{useGrouping:!1}).format(g);return{monthName:m,hebrewYear:x}}function me(a,s){const m=new I(s),g=new Intl.NumberFormat("he-IL-u-nu-hebr",{useGrouping:!1}).format(m.getDate());return t.jsxs("div",{className:"flex flex-col items-center leading-tight py-0.5",children:[t.jsx("span",{className:"text-[13px]",children:a}),t.jsx("span",{className:"text-[11px] opacity-80",children:g})]})}function be(){const[a,s]=u.useState([]),[m,g]=u.useState(!0),[x,n]=u.useState(null),[h,b]=u.useState(null),[O,D]=u.useState(!1),[F,l]=u.useState(null),[f,p]=u.useState(""),[j,i]=u.useState(""),[N,k]=u.useState(""),[S,E]=u.useState(""),[y,C]=u.useState(null),[M,B]=u.useState([]),T=`
    .react-datepicker__day.has-story { background-color: #dcfce7; color: #166534; border-radius: 50%; font-weight: bold; }
  `;function V(){try{const e=["honoree","last_name","father_name","gender","event_date"],r=a.map(L=>{const te=o(L.honoree),ae=o(L.last_name||""),re=o(L.father_name||""),se=L.gender||"",ne=L.event_date||"";return[te,ae,re,se,ne].map(le=>{const H=String(le??"");return/[",\n]/.test(H)?'"'+H.replace(/"/g,'""')+'"':H}).join(",")}),d="\uFEFF",w=[e.join(","),...r].join(`
`),c=new Blob([d+w],{type:"text/csv;charset=utf-8;"}),_=URL.createObjectURL(c),v=document.createElement("a"),A=new Date,X=A.getFullYear(),Z=String(A.getMonth()+1).padStart(2,"0"),ee=String(A.getDate()).padStart(2,"0");v.href=_,v.download=`memorials-${X}-${Z}-${ee}.csv`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(_)}catch(e){console.error(e),alert("שגיאה ביצוא CSV")}}async function $(){try{g(!0),n(null);const{data:e,error:r}=await oe();r&&console.error("Error fetching memorials, possibly due to malformed data:",r),s(e||[])}catch(e){n(e.message||"שגיאה בטעינת הנתונים")}finally{g(!1)}}u.useEffect(()=>{$()},[]),u.useEffect(()=>{(async()=>{try{const{data:e}=await R.from("stories").select("play_date").not("play_date","is",null),r=new Set;(e||[]).forEach(c=>{c.play_date&&r.add(String(c.play_date))});const d=[];for(const c of Array.from(r)){const _=new Date(c);if(!isNaN(_.getTime())){d.push(new Date(_.getFullYear(),_.getMonth(),_.getDate()));continue}const v=U(c);v&&d.push(v)}const w=new Map;d.forEach(c=>w.set(`${c.getFullYear()}-${c.getMonth()}-${c.getDate()}`,c)),B(Array.from(w.values()))}catch{}})()},[]);function P(){l(null),p(""),i(""),k(""),E(""),C(null),D(!0)}function J(e){l(e.id);const r=o(Array.isArray(e.honoree)?String(e.honoree[0]??""):String(e.honoree??"")),d=o(Array.isArray(e.last_name)?e.last_name[0]??"":e.last_name||""),w=o(Array.isArray(e.father_name)?e.father_name[0]??"":e.father_name||""),c=Array.isArray(e.gender)?e.gender[0]??null:e.gender??null;k(w),p(r),i(d),E(c||""),C(e.event_date?new Date(e.event_date):null),D(!0)}async function K(){const e=o(f);if(!e){n("יש למלא שם נזכר/ת");return}try{n(null);const r={honoree:e,last_name:o(j)||null,father_name:o(N)||null,gender:S||null,event_date:y?y.toISOString().slice(0,10):null},{error:d}=F?await ie(F,r):await G(r);if(d)throw new Error(d);b(`נשמר בהצלחה: ${e}`),D(!1),await $()}catch(r){n(r.message||"שגיאה בשמירה")}}async function Q(e){if(confirm("למחוק את הרשומה?"))try{n(null);const{error:r}=await ce(e);if(r)throw new Error(r);b("נמחק בהצלחה"),await $()}catch(r){n(r.message||"שגיאה במחיקה")}}async function W(){if(a.length===0){alert("אין רשומות למחיקה");return}if(confirm(`האם למחוק את כל ${a.length} הנפטרים? פעולה זו בלתי הפיכה.`))try{n(null);const e=a.map(d=>d.id),{error:r}=await R.from("memorials").delete().in("id",e);if(r)throw r;b(`נמחקו ${e.length} רשומות בהצלחה`),await $()}catch(e){n(e.message||"שגיאה במחיקה הגלובאלית")}}return t.jsxs("section",{className:"p-6 space-y-6",dir:"rtl",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h1",{className:"text-2xl font-bold",children:"לעילוי נשמת (ניהול)"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{className:"px-4 py-2 rounded-lg border",onClick:()=>{var e;return(e=z.current)==null?void 0:e.click()},children:"ייבוא CSV"}),t.jsx("button",{className:"px-4 py-2 rounded-lg border border-red-300 text-red-600",onClick:W,children:"מחיקה גלובאלית"}),t.jsx("button",{className:"px-4 py-2 rounded-lg border",onClick:V,children:"ייצוא CSV"}),t.jsx("input",{ref:z,type:"file",accept:".csv,text/csv",className:"hidden",onChange:ge}),t.jsx("button",{className:"px-4 py-2 rounded-lg bg-blue-600 text-white",onClick:P,children:"הוספת רשומה"})]})]}),x&&t.jsx("div",{className:"bg-red-50 text-red-700 p-3 rounded",children:x}),h&&t.jsx("div",{className:"bg-green-50 text-green-700 p-3 rounded",children:h}),m?t.jsx("div",{className:"text-gray-500",children:"טוען…"}):t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full border rounded-2xl overflow-hidden",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"p-3 text-right",children:"שם"}),t.jsx("th",{className:"p-3 text-right",children:"שם האב"}),t.jsx("th",{className:"p-3 text-right",children:"מין"}),t.jsx("th",{className:"p-3 text-right",children:"תאריך פטירה (עברי)"}),t.jsx("th",{className:"p-3 text-right"})]})}),t.jsxs("tbody",{children:[a.map(e=>t.jsxs("tr",{className:"border-t",children:[t.jsx("td",{className:"p-3 font-medium",children:o(e.honoree)}),t.jsx("td",{className:"p-3",children:o(e.last_name||"")||"—"}),t.jsx("td",{className:"p-3",children:o(e.father_name||"")||"—"}),t.jsx("td",{className:"p-3",children:e.gender==="male"?"גבר":e.gender==="female"?"אישה":"—"}),t.jsx("td",{className:"p-3",children:e.event_date?Y(e.event_date):"—"}),t.jsx("td",{className:"p-3",children:t.jsxs("div",{className:"flex flex-wrap gap-2 justify-end",children:[t.jsx("button",{className:"px-3 py-1 rounded-lg border",onClick:()=>J(e),children:"עריכה"}),t.jsx("button",{className:"px-3 py-1 rounded-lg border border-red-300 text-red-600",onClick:()=>Q(e.id),children:"מחיקה"})]})})]},e.id)),a.length===0&&t.jsx("tr",{children:t.jsx("td",{className:"p-3 text-gray-500",colSpan:5,children:"אין נתונים להצגה."})})]})]})}),O&&t.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 grid place-items-center p-4",onClick:()=>D(!1),children:t.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-6",onClick:e=>e.stopPropagation(),children:[t.jsx("h2",{className:"text-lg font-semibold mb-4",children:F?"עריכת רשומה":"רשומה חדשה"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm text-gray-600",children:"שם נזכר/ת *"}),t.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:f,onChange:e=>p(e.target.value),onBlur:e=>p(o(e.target.value))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm text-gray-600",children:"שם האב"}),t.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:N,onChange:e=>k(e.target.value),onBlur:e=>k(o(e.target.value))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm text-gray-600",children:"מין"}),t.jsxs("select",{className:"w-full mt-1 border rounded-lg p-2 bg-white",value:S,onChange:e=>E(e.target.value),children:[t.jsx("option",{value:"",children:"לא צוין"}),t.jsx("option",{value:"male",children:"גבר"}),t.jsx("option",{value:"female",children:"אישה"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm text-gray-600",children:"תאריך פטירה"}),t.jsx("style",{children:T}),t.jsx("style",{children:T}),t.jsx(de,{selected:y,onChange:e=>C(e),inline:!0,showPopperArrow:!1,className:"w-full mt-1 border rounded-lg p-2 text-right",calendarStartDay:0,highlightDates:[{"has-story":M}],highlightDates:[{"has-story":M}],renderCustomHeader:({date:e,decreaseMonth:r,increaseMonth:d})=>{const{monthName:w,hebrewYear:c}=he(e);return t.jsxs("div",{className:"flex items-center justify-between px-2 py-1",children:[t.jsx("button",{type:"button",onClick:r,className:"px-2 text-lg",children:"‹"}),t.jsxs("div",{className:"font-semibold",children:[w," ",c]}),t.jsx("button",{type:"button",onClick:d,className:"px-2 text-lg",children:"›"})]})},renderDayContents:me}),t.jsx("button",{type:"button",className:"text-sm text-blue-600 hover:underline mt-1",onClick:()=>C(null),children:"נקה תאריך"}),y&&t.jsxs("div",{className:"mt-1 text-sm text-gray-600",children:["עברי: ",Y(y)]})]})]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("label",{className:"text-sm text-gray-600",children:"שם משפחה"}),t.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:j,onChange:e=>i(e.target.value),onBlur:e=>i(o(e.target.value))})]}),t.jsxs("div",{className:"flex gap-2 mt-6 justify-end",children:[t.jsx("button",{className:"bg-gray-200 px-4 py-2 rounded-lg",onClick:()=>D(!1),children:"ביטול"}),t.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg",onClick:K,children:"שמור"})]})]})})]})}const z={current:null};async function ge(a){var m;const s=(m=a.target.files)==null?void 0:m[0];if(s)try{const x=(await s.text()).split(/\r?\n/).filter(l=>l.trim()!=="");if(x.length===0)return;const n=l=>{const f=[];let p="",j=!1;for(let i=0;i<l.length;i++){const N=l[i];if(N==='"'){j=!j;continue}if(N===","&&!j){f.push(p),p="";continue}p+=N}return f.push(p),f.map(i=>i.trim())},h=["honoree","father_name","gender","event_date"],b=n(x[0]).map(l=>l.toLowerCase()),F=(h.some(l=>b.includes(l))?x.slice(1):x).map(n).map(l=>{const[f,p,j,i]=l,N=o(f),k=o(p),S=(j||"").toLowerCase(),E=S==="male"||S==="זכר"?"male":S==="female"||S==="נקבה"?"female":null;let y=null;if(i){const C=new Date(i);if(!isNaN(C.getTime()))y=C.toISOString().slice(0,10);else{const M=U(i);M&&(y=M.toISOString().slice(0,10))}}return{honoree:N,father_name:k||null,gender:E,event_date:y}}).filter(l=>l.honoree);for(const l of F){const{error:f}=await G(l);if(f)throw new Error(f)}alert(`יובאו ${F.length} נפטרים בהצלחה`),a.target.value=""}catch(g){alert(g.message||"שגיאה בייבוא CSV")}}export{be as Component};
