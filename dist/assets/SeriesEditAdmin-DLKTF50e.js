import{c as X,f as Y,r as i,j as e,L as Z,s as x}from"./index-B54MtHlO.js";import{L as ee}from"./loader-circle-D6by3rio.js";/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]],se=X("grip-vertical",te),O="media";async function P(u,l){const c=(u.name.split(".").pop()||"bin").toLowerCase(),g=`${c==="mp3"||c==="m4a"?"mp3":l}/${Date.now()}-${Math.random().toString(16).slice(2)}.${c}`,{error:b}=await x.storage.from(O).upload(g,u,{upsert:!1,cacheControl:"3600",contentType:u.type||(["jpg","jpeg","png","gif","webp","avif"].includes(c)?`image/${c==="jpg"?"jpeg":c}`:c==="mp3"?"audio/mpeg":c==="m4a"?"audio/mp4":void 0)});if(b)throw b;const{data:v}=x.storage.from(O).getPublicUrl(g);return v.publicUrl}function ne(){const{seriesId:u}=Y(),[l,c]=i.useState(null),[m,g]=i.useState([]),[b,v]=i.useState(!0),[E,a]=i.useState(null),[I,d]=i.useState(null),[f,o]=i.useState(!1),[z,N]=i.useState(!1),[re,le]=i.useState(""),[w,$]=i.useState(null),[S,T]=i.useState(null),[_,k]=i.useState(""),[j,L]=i.useState(null),[C,q]=i.useState(null);i.useEffect(()=>{if(!u)return;async function t(){try{v(!0),a(null);const{data:s,error:r}=await x.from("series").select("id, title, description, cover_url").eq("id",u).single();if(r)throw r;c(s);const{data:n,error:h}=await x.from("stories").select("id, title, audio_url, series_order").eq("series_id",u).order("series_order",{ascending:!0,nullsFirst:!1});if(h)throw h;g(n||[])}catch(s){a(s.message||"שגיאה בטעינת נתוני הסדרה")}finally{v(!1)}}t()},[u]);const D=(t,s)=>{l&&c({...l,[t]:s})},A=async()=>{if(l)try{a(null),d(null),o(!0);const{error:t}=await x.from("series").update({title:l.title,description:l.description,cover_url:l.cover_url}).eq("id",l.id);if(t)throw t;d("פרטי הסדרה עודכנו בהצלחה!")}catch(t){a(t.message||"שגיאה בעדכון פרטי הסדרה")}finally{o(!1)}},K=async t=>{var r;const s=(r=t.target.files)==null?void 0:r[0];if(!(!s||!l))try{a(null),d(null),o(!0);const n=await P(s,"images");c({...l,cover_url:n}),d('תמונת הנושא הועלתה. יש ללחוץ על "שמור שינויים" כדי לעדכן.')}catch(n){a(n.message||"שגיאת העלאת תמונה")}finally{o(!1),t.target.value=""}},R=async()=>{var t;if(!u||!w||w.length===0){a("יש לבחור קובץ שמע אחד או יותר.");return}try{a(null),d(null),o(!0);let s=((t=m[m.length-1])==null?void 0:t.series_order)||0;const r=[];for(const n of Array.from(w)){const h=await P(n,"mp3"),p=n.name.replace(/\.[^/.]+$/,"");s++;const{data:y,error:M}=await x.from("stories").insert({title:p,series_id:u,audio_url:h,series_order:s}).select("id, title, audio_url, series_order").single();if(M)throw M;r.push(y)}g([...m,...r]),d(`${r.length} פרקים נוספו בהצלחה!`),N(!1),$(null)}catch(s){a(s.message||`שגיאה בהוספת ${w.length>1?"פרקים":"פרק"}`)}finally{o(!1)}},G=async t=>{if(confirm("האם למחוק את הפרק הזה? הפעולה תסיר אותו לצמיתות."))try{a(null),d(null),o(!0);const{error:s}=await x.from("stories").delete().eq("id",t);if(s)throw s;g(m.filter(r=>r.id!==t)),d("הפרק נמחק בהצלחה.")}catch(s){a(s.message||"שגיאה במחיקת הפרק")}finally{o(!1)}},V=async(t,s)=>{const r=[...m],n=t-1;if(n<0||n>=r.length)return;[r[t],r[n]]=[r[n],r[t]];const h=r.map((p,y)=>({...p,series_order:y+1}));g(h);try{o(!0),a(null);for(const p of h){const{error:y}=await x.from("stories").update({series_order:p.series_order}).eq("id",p.id);if(y)throw y}d("סדר הפרקים עודכן")}catch(p){a(p.message||"שגיאה בעדכון סדר הפרקים")}finally{o(!1)}},H=t=>{T(t.id),k(t.title)},F=()=>{T(null),k("")},U=async()=>{if(!S||!_.trim()){F();return}try{a(null),d(null),o(!0);const{error:t}=await x.from("stories").update({title:_.trim()}).eq("id",S);if(t)throw t;g(m.map(s=>s.id===S?{...s,title:_.trim()}:s)),d("שם הפרק עודכן."),F()}catch(t){a(t.message||"שגיאה בעדכון שם הפרק")}finally{o(!1)}},J=t=>{L(t)},Q=t=>{j===null||j===t||q(t)},W=async()=>{if(j===null||C===null||j===C){B();return}[...m],await V(C),B()},B=()=>{L(null),q(null)};return b?e.jsx("div",{className:"p-6",children:"טוען נתונים..."}):E?e.jsx("div",{className:"p-6 text-red-600",children:E}):l?e.jsxs("section",{className:"p-6 space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h1",{className:"text-2xl font-bold",children:["עריכת סדרה: ",l.title]}),e.jsx(Z,{to:"/admin/series",className:"text-sm text-blue-600 hover:underline",children:"← חזרה לכל הסדרות"})]}),I&&e.jsx("div",{className:"rounded-lg bg-green-50 text-green-700 p-3",children:I}),e.jsxs("div",{className:"p-4 border rounded-2xl bg-white space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"פרטי הסדרה"}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"שם הסדרה (כותרת)"}),e.jsx("input",{type:"text",value:l.title,onChange:t=>D("title",t.target.value),className:"w-full mt-1 border rounded-lg p-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"תקציר"}),e.jsx("textarea",{value:l.description||"",onChange:t=>D("description",t.target.value),className:"w-full mt-1 border rounded-lg p-2 min-h-[100px]"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"תמונת נושא"}),e.jsxs("div",{className:"flex items-center gap-4 mt-1",children:[l.cover_url&&e.jsx("img",{src:l.cover_url,alt:"תמונת נושא",className:"w-20 h-20 rounded-lg object-cover border"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("input",{type:"text",placeholder:"הדבק URL או העלה קובץ",value:l.cover_url||"",onChange:t=>D("cover_url",t.target.value),className:"w-full border rounded-lg p-2"}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"או העלאה:"}),e.jsx("input",{type:"file",accept:"image/*",onChange:K,disabled:f,className:"text-sm"})]})]})]}),e.jsx("div",{className:"text-left",children:e.jsx("button",{onClick:A,disabled:f,className:"bg-blue-600 text-white px-4 py-2 rounded-lg disabled:opacity-50",children:"שמור שינויים בסדרה"})})]}),e.jsxs("div",{className:"p-4 border rounded-2xl bg-white space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"פרקי הסדרה"}),e.jsx("button",{onClick:()=>N(!0),className:"bg-green-600 text-white px-3 py-1 rounded-lg text-sm",children:"+ הוסף פרק/קובץ שמע"})]}),e.jsxs("div",{className:"divide-y border rounded-lg",children:[m.map((t,s)=>e.jsxs("div",{draggable:!0,onDragStart:()=>J(s),onDragEnter:()=>Q(s),onDragEnd:W,onDragOver:r=>r.preventDefault(),className:`flex items-center p-2 gap-3 transition-colors cursor-grab ${j===s?"bg-blue-100 opacity-50":""} ${C===s?"border-t-2 border-blue-500":""}`,children:[e.jsx(se,{className:"w-5 h-5 text-gray-400"}),e.jsxs("span",{className:"text-sm text-gray-500 w-6 text-center",children:[s+1,"."]}),S===t.id?e.jsx("input",{type:"text",value:_,onChange:r=>k(r.target.value),onKeyDown:r=>r.key==="Enter"&&U(),onBlur:U,className:"flex-1 font-medium p-1 border rounded-md",autoFocus:!0}):e.jsx("div",{className:"flex-1 font-medium",children:t.title}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>H(t),disabled:f,className:"text-blue-500 hover:text-blue-700 disabled:opacity-50 text-sm px-2 py-1",children:"ערוך"}),e.jsx("button",{onClick:()=>G(t.id),disabled:f,className:"text-red-500 hover:text-red-700 disabled:opacity-50 text-sm px-2 py-1",children:"מחק"})]})]},t.id)),m.length===0&&e.jsx("div",{className:"p-3 text-gray-500",children:"אין עדיין פרקים בסדרה זו."})]})]}),z&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 grid place-items-center p-4",onClick:()=>N(!1),children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-lg p-6",onClick:t=>t.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"הוספת פרק חדש"}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"קובץ שמע *"}),e.jsx("input",{type:"file",accept:"audio/*",multiple:!0,onChange:t=>{$(t.target.files)},className:"w-full mt-1 text-sm"})]})}),e.jsxs("div",{className:"flex gap-2 mt-6 justify-end",children:[e.jsx("button",{className:"bg-gray-200 px-4 py-2 rounded-lg",onClick:()=>N(!1),disabled:f,children:"ביטול"}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg disabled:opacity-50",onClick:R,disabled:f,children:f?e.jsx(ee,{className:"animate-spin"}):"הוסף והעלה"})]})]})})]}):e.jsx("div",{className:"p-6",children:"לא נמצאה סדרה."})}export{ne as Component};
