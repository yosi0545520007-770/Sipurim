import{r as d,j as e,s as h,H as L}from"./index-DhAAA4kQ.js";import{D as re}from"./react-datepicker-CAsIfJ14.js";import{L as le}from"./loader-circle-tv_5jQAW.js";import"./clsx-B-dksMZM.js";function H({ok:s}){return e.jsx("span",{className:s?"text-green-600":"text-red-500",children:s?"✓":"✗"})}function ne(s){return s instanceof Date&&!isNaN(s.getTime())}function A(s){const n=s?new Date(s):new Date;return ne(n)?n:new Date}function T(s){return s.normalize("NFD").replace(/[\u0591-\u05C7]/g,"").normalize("NFC")}function ie(s){const n=["","א","ב","ג","ד","ה","ו","ז","ח","ט"],a=["","י","כ","ל","מ","נ","ס","ע","פ","צ"],p=["","ק","ר","ש","ת","תתק"],c=s%1e3,g=Math.floor(c/100);let x=Math.floor(c%100/10),u=c%10;x===1&&(u===5||u===6)&&(x=0,u=u===5?15:16);const w=u===15?"טו":u===16?"טז":n[u],i=(p[g]||"")+(a[x]||"")+w;return i.length>=2?i.slice(0,-1)+"״"+i.slice(-1):i+"׳"}function Y(s){try{const n=A(s),a=new L(n);return typeof a.renderGematriya=="function"?a.renderGematriya():typeof a.render=="function"?a.render("he"):""}catch{return""}}function ce(s){try{const n=A(s),a=new L(n),p=typeof a.renderGematriya=="function"?String(a.renderGematriya()).split(" ")[0]:String(a.getDate&&a.getDate())||"";let c=a.getMonthName&&a.getMonthName("he")||"";(!c||/[A-Za-z]/.test(c))&&(c=(typeof a.render=="function"?String(a.render("he")).split(" "):[])[1]||"");const g=T(String(c));return{dayG:p,monthHe:g}}catch{return{dayG:"",monthHe:""}}}function de(s){const n=new L(s);let a=n.getMonthName&&n.getMonthName("he")||"";const p=T(String(a)),c=n.getFullYear&&n.getFullYear()||5785;return{month:p,year:ie(c)}}const $="media";async function oe(s,n){const a=(s.name.split(".").pop()||"bin").toLowerCase(),c=`${a==="mp3"||a==="m4a"?"mp3":n}/${Date.now()}-${Math.random().toString(16).slice(2)}.${a}`,{error:g}=await h.storage.from($).upload(c,s,{upsert:!1,cacheControl:"3600",contentType:s.type||(["jpg","jpeg","png","gif","webp","avif"].includes(a)?`image/${a==="jpg"?"jpeg":a}`:a==="mp3"?"audio/mpeg":a==="m4a"?"audio/mp4":void 0)});if(g)throw g;const{data:x}=h.storage.from($).getPublicUrl(c);return x.publicUrl}function fe(){const[s,n]=d.useState([]),[a,p]=d.useState([]),[c,g]=d.useState([]),[x,u]=d.useState(!0),[w,i]=d.useState(null),[M,j]=d.useState(null),[v,_]=d.useState(!1),[U,y]=d.useState(!1),[D,P]=d.useState(null),[l,m]=d.useState({title:"",excerpt:"",image_url:"",audio_url:"",play_date:"",category_id:""});async function q(){try{const[{data:t},{data:r}]=await Promise.all([h.from("series").select("id, title").order("title"),h.from("categories").select("id, name").order("name")]);p(t||[]),g(r||[])}catch{i("שגיאה בטעינת סדרות וקטגוריות")}}async function C(){try{u(!0),i(null);const{data:t,error:r}=await h.from("stories").select("id,title,excerpt,image_url,audio_url,publish_at,play_date,updated_at,series_id,series_order,category_id").is("series_id",null).order("updated_at",{ascending:!1});if(r)throw r;n(t||[])}catch(t){i(t.message||"שגיאה בטעינת הסיפורים")}finally{u(!1)}}d.useEffect(()=>{q(),C()},[]);function B(){P(null),m({title:"",excerpt:"",image_url:"",audio_url:"",play_date:"",category_id:""}),y(!0)}function O(t){P(t.id),m({title:t.title||"",excerpt:t.excerpt||"",image_url:t.image_url||"",audio_url:t.audio_url||"",play_date:t.play_date||"",category_id:t.category_id||""}),y(!0)}const[R,b]=d.useState(!1),[K,z]=d.useState(new Date),[F,I]=d.useState(""),[f,S]=d.useState(new Set);function V(){const t=new Date;z(t),I(Y(t)),b(!0)}function Z(){m(t=>({...t,play_date:F})),b(!1)}const J=async t=>{var o;const r=(o=t.target.files)==null?void 0:o[0];if(r)try{i(null),j(null),_(!0);const N=await oe(r,"images");m({...l,image_url:N}),j('התמונה הועלתה. יש ללחוץ על "שמירה" כדי לעדכן.')}catch(N){i(N.message||"שגיאת העלאת תמונה")}finally{_(!1),t.target.value=""}};async function Q(){try{if(i(null),j(null),_(!0),!l.title.trim())throw new Error("כותרת היא שדה חובה.");const t={title:l.title.trim(),excerpt:l.excerpt.trim()||null,image_url:l.image_url.trim()||null,audio_url:l.audio_url.trim()||null,play_date:l.play_date,category_id:l.category_id?l.category_id:null};if(D){const{error:r}=await h.from("stories").update(t).eq("id",D);if(r)throw r;j("הסיפור עודכן בהצלחה!")}else{const{error:r}=await h.from("stories").insert(t);if(r)throw r;j("הסיפור נוצר בהצלחה!")}y(!1),await C()}catch(t){i(t.message||"שגיאה בשמירת הסיפור")}finally{_(!1)}}const W=t=>{S(r=>{const o=new Set(r);return o.has(t)?o.delete(t):o.add(t),o})},X=t=>{t.target.checked?S(new Set(s.map(r=>r.id))):S(new Set)},ee=s.length>0&&f.size===s.length;async function te(t){if(confirm("האם למחוק את הסיפור?"))try{i(null);const{error:r}=await h.from("stories").delete().eq("id",t);if(r)throw r;j("הסיפור נמחק בהצלחה"),await C()}catch(r){i(r.message||"שגיאה במחיקת הסיפור")}}async function se(){if(f.size!==0&&confirm(`האם למחוק ${f.size} סיפורים נבחרים?`))try{i(null);const{error:t}=await h.from("stories").delete().in("id",Array.from(f));if(t)throw t;j(`${f.size} סיפורים נמחקו בהצלחה`),S(new Set),await C()}catch(t){i(t.message||"שגיאה במחיקה גורפת")}}return e.jsxs("section",{className:"p-6 space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"ניהול סיפורים"}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-xl",onClick:B,children:"+ סיפור חדש"})]}),w&&e.jsx("div",{className:"rounded-lg bg-red-50 text-red-700 p-3",children:w}),M&&e.jsx("div",{className:"rounded-lg bg-green-50 text-green-700 p-3",children:M}),x&&e.jsx("div",{children:"טוען רשימת סיפורים..."}),!x&&e.jsxs("div",{className:"rounded-2xl border overflow-x-auto bg-white",children:[f.size>0&&e.jsxs("div",{className:"p-2 bg-blue-50 border-b flex items-center gap-4",children:[e.jsxs("span",{className:"text-sm text-blue-800",children:[f.size," פריטים נבחרו"]}),e.jsx("button",{onClick:se,className:"px-3 py-1 rounded-lg border border-red-300 bg-red-50 text-red-600 text-sm",children:"מחק נבחרים"})]}),e.jsxs("table",{className:"w-full min-w-[800px] text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 w-10",children:e.jsx("input",{type:"checkbox",checked:ee,onChange:X,className:"rounded"})}),e.jsx("th",{className:"p-3 text-right",children:"כותרת"}),e.jsx("th",{className:"p-3 text-center",children:"תמונה"}),e.jsx("th",{className:"p-3 text-center",children:"שמע"}),e.jsx("th",{className:"p-3 text-right",children:"תאריך השמעה"}),e.jsx("th",{className:"p-3 text-right",children:"פעולות"})]})}),e.jsxs("tbody",{children:[s.map(t=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3 text-center",children:e.jsx("input",{type:"checkbox",checked:f.has(t.id),onChange:()=>W(t.id),className:"rounded"})}),e.jsxs("td",{className:"p-3 align-top",children:[e.jsx("div",{className:"font-medium",children:t.title}),t.excerpt&&e.jsx("div",{className:"text-xs text-gray-600 mt-1 line-clamp-2",children:t.excerpt})]}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(H,{ok:!!t.image_url})}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(H,{ok:!!t.audio_url})}),e.jsx("td",{className:"p-3",children:t.play_date||"—"}),e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex flex-wrap gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1 rounded-lg border",onClick:()=>O(t),children:"עריכה"}),e.jsx("button",{className:"px-3 py-1 rounded-lg border border-red-300 text-red-600",onClick:()=>te(t.id),children:"מחיקה"})]})})]},t.id)),s.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"p-3 text-gray-500",colSpan:6,children:"לא נמצאו סיפורים."})})]})]})]}),U&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 grid place-items-center p-4",onClick:()=>y(!1),children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6",onClick:t=>t.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:D?"עריכת סיפור":"סיפור חדש"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"כותרת *"}),e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:l.title,onChange:t=>m({...l,title:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"תקציר"}),e.jsx("textarea",{className:"w-full mt-1 border rounded-lg p-2 min-h-[100px]",value:l.excerpt,onChange:t=>m({...l,excerpt:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"כתובת תמונה"}),e.jsxs("div",{className:"flex items-center gap-4 mt-1",children:[l.image_url&&e.jsx("img",{src:l.image_url,alt:"תצוגה מקדימה",className:"w-16 h-16 rounded-lg object-cover border"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("input",{className:"w-full border rounded-lg p-2",placeholder:"הדבק URL או העלה קובץ",value:l.image_url,onChange:t=>m({...l,image_url:t.target.value})}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"או העלאה:"}),e.jsx("input",{type:"file",accept:"image/*",onChange:J,disabled:v,className:"text-sm"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"כתובת קובץ שמע"}),e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:l.audio_url,onChange:t=>m({...l,audio_url:t.target.value})}),l.audio_url&&e.jsx("audio",{controls:!0,src:l.audio_url,className:"w-full mt-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"תאריך השמעה (עברי)"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",placeholder:"לדוגמא: י״ד אלול תשפ״ה",value:l.play_date||"",onChange:t=>m({...l,play_date:t.target.value})}),e.jsx("button",{type:"button",className:"px-3 py-2 rounded-lg border",onClick:V,children:"בחירה"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"קטגוריה"}),e.jsxs("select",{className:"w-full mt-1 border rounded-lg p-2 bg-white",value:l.category_id,onChange:t=>m({...l,category_id:t.target.value}),children:[e.jsx("option",{value:"",children:"— ללא —"}),c.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6 justify-end",children:[e.jsx("button",{className:"bg-gray-200 px-4 py-2 rounded-lg",onClick:()=>y(!1),disabled:v,children:"ביטול"}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg disabled:opacity-50",onClick:Q,disabled:v,children:v?e.jsx(le,{className:"animate-spin"}):"שמירה"})]})]})}),R&&e.jsx("div",{className:"fixed inset-0 bg-black/30 grid place-items-center z-[60]",onClick:()=>b(!1),children:e.jsxs("div",{className:"bg-white rounded-2xl p-4 w-full max-w-md",onClick:t=>t.stopPropagation(),dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"בחר תאריך השמעה"}),e.jsx("button",{onClick:()=>b(!1),className:"text-gray-500",children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(re,{selected:K,onChange:t=>{z(t),I(Y(t||new Date))},inline:!0,calendarStartDay:0,isClearable:!1,showPopperArrow:!1,renderCustomHeader:({date:t,decreaseMonth:r,increaseMonth:o,changeYear:N,changeMonth:ue})=>{const k=t;k.getFullYear(),k.getMonth();const ae=k.toLocaleDateString("he-IL",{month:"long",year:"numeric"}),E=de(k);return Array.from({length:12},(me,G)=>({idx:G,label:new Date(2020,G,1).toLocaleDateString("he-IL",{month:"long"})})),e.jsxs("div",{className:"px-2 py-1",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",onClick:r,className:"px-2 text-lg",children:"‹"}),e.jsx("div",{className:"font-semibold",children:ae}),e.jsx("button",{type:"button",onClick:o,className:"px-2 text-lg",children:"›"})]}),e.jsxs("div",{className:"text-sm text-gray-600 text-center mt-1",children:[E.month," ",E.year]})]})},renderDayContents:(t,r)=>{const{dayG:o,monthHe:N}=ce(r);return e.jsxs("div",{className:"flex flex-col items-center leading-tight py-0.5",children:[e.jsx("span",{className:"text-[13px]",children:t}),e.jsx("span",{className:"text-[11px] opacity-80",children:o})]})}}),e.jsxs("div",{className:"rounded-lg border p-3 bg-gray-50",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-1",children:"תאריך נבחר (עברי):"}),e.jsx("div",{className:"font-medium",children:F||"—"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded-lg border",onClick:()=>b(!1),children:"ביטול"}),e.jsx("button",{className:"px-3 py-2 rounded-lg bg-blue-600 text-white",onClick:Z,children:"בחר"})]})]})]})})]})}export{fe as Component};
