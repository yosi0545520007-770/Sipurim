import{c as L,b as M,d as $,r as l,s as n,j as t}from"./index-B54MtHlO.js";import{L as z}from"./loader-circle-D6by3rio.js";/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}]],A=L("heart",U);function F(){const m=M(),{isHeard:v}=$(),[u,w]=l.useState(null),[o,x]=l.useState([]),[_,k]=l.useState([]),[d,C]=l.useState(""),[g,P]=l.useState(!1),[f,p]=l.useState(!0),[N,b]=l.useState(null),h=24,[S,y]=l.useState(!0);l.useEffect(()=>{(async()=>{const{data:a}=await n.auth.getUser();w(a.user)})();const{data:{subscription:s}}=n.auth.onAuthStateChange((a,r)=>{w((r==null?void 0:r.user)??null)});return()=>s.unsubscribe()},[]),l.useEffect(()=>{(async()=>{try{p(!0),b(null);const{data:e}=await n.from("categories").select("id,title").order("title");k(e||[]);let s={_limit:h,_offset:0};d&&(s._category_id=d);const{data:a,error:r}=await n.rpc("get_stories_with_favorites",s);if(r)throw r;const i=a||[];x(i),y(i.length>=h)}catch(e){b(e.message||"שגיאה בטעינת סיפורים")}finally{p(!1)}})()},[d,u]);async function E(){try{const e=o.length;let s={_limit:h,_offset:e};d&&(s._category_id=d);const{data:a,error:r}=await n.rpc("get_stories_with_favorites",s);if(r)throw r;const i=a||[];x(c=>[...c,...i]),i.length<h&&y(!1)}catch(e){b(e.message||"שגיאה בטעינת סיפורים")}finally{p(!1)}}const H=async(e,s)=>{if(!u){alert("יש להתחבר כדי לסמן סיפורים אהובים.");return}x(o.map(a=>a.id===e?{...a,is_favorited:!s}:a));try{s?await n.from("favorite_stories").delete().match({user_id:u.id,story_id:e}):await n.from("favorite_stories").insert({user_id:u.id,story_id:e})}catch{x(o.map(r=>r.id===e?{...r,is_favorited:s}:r)),alert("שגיאה בעדכון מועדפים.")}};let j=o;return g&&(j=j.filter(e=>{const s=m.getProgress(e.id);return!(!!s&&s.dur>0&&s.pos>=s.dur-2)&&!v(e.id)})),t.jsxs("section",{className:"p-6 max-w-6xl mx-auto",dir:"rtl",children:[t.jsx("div",{className:"flex items-center gap-3 mb-4",children:t.jsxs("div",{className:"flex items-center gap-2 flex-wrap justify-start w-full",children:[_.length>0&&t.jsxs("select",{className:"border rounded-lg p-2 bg-white text-sm",value:d,onChange:e=>C(e.target.value),children:[t.jsx("option",{value:"",children:"בחר/י קטגוריה להשמעה"}),_.map(e=>t.jsx("option",{value:e.id,children:e.title},e.id))]}),t.jsx("button",{type:"button",onClick:()=>P(e=>!e),className:`px-3 py-2 rounded-lg border text-sm transition-colors ${g?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700"}`,children:g?"סינון פעיל":"הסתר סיפורים ששמעתי"})]})}),N&&t.jsx("div",{className:"bg-red-50 text-red-700 p-3 rounded mb-4",children:N}),f&&o.length===0&&t.jsx("div",{className:"text-gray-500",children:"טוען…"}),t.jsx("div",{className:"grid gap-6 sm:grid-cols-2 lg:grid-cols-3",children:j.map(e=>{const s=e.image_url||"",a=m.getProgress(e.id),r=!!a&&(a.pos||0)>0,i=!!a&&a.dur>0&&a.pos>=a.dur-2||v(e.id);return t.jsx("a",{href:`/story/${e.id}`,className:"relative block rounded-2xl border bg-white overflow-hidden shadow-sm transition-shadow hover:shadow-md",children:t.jsxs("article",{children:[(i||r)&&t.jsx("span",{className:`absolute top-2 right-2 text-[11px] px-2 py-0.5 rounded-full z-10 ${i?"bg-green-600 text-white":"bg-blue-600 text-white"}`,children:i?"נשמע":"בתהליך"}),u&&t.jsx("button",{onClick:c=>{c.preventDefault(),c.stopPropagation(),H(e.id,e.is_favorited)},className:"absolute top-2 left-2 z-10 p-1.5 rounded-full bg-white/70 backdrop-blur-sm",children:t.jsx(A,{className:`w-5 h-5 transition-colors ${e.is_favorited?"text-red-500 fill-red-500":"text-gray-500"}`})}),t.jsxs("div",{className:"relative w-full aspect-[16/9] overflow-hidden bg-gray-100 group",children:[t.jsx("div",{className:"w-full h-full",children:s?t.jsx("img",{src:s,alt:e.title,className:"w-full h-full object-cover object-center",loading:"lazy"}):t.jsx("div",{className:"w-full h-full grid place-items-center text-xs text-gray-400",children:"ללא תמונה"})}),e.audio_url&&t.jsxs("button",{onClick:c=>{c.preventDefault(),c.stopPropagation(),m.playTrack({id:e.id,title:e.title,audio_url:e.audio_url})},className:"absolute inset-0 flex flex-col items-center justify-center gap-3 bg-black/35 text-white text-sm font-medium text-center p-3","aria-label":`נגן את ${e.title}`,children:[t.jsx("span",{className:"w-12 h-12 rounded-full bg-gray-800/60 text-white backdrop-blur flex items-center justify-center",children:t.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-6 h-6 ml-0.5","aria-hidden":"true",children:t.jsx("path",{d:"M8 5v14l11-7z"})})}),t.jsx("span",{className:"px-3 py-1 rounded-full bg-black/60 text-xs sm:text-sm",children:"לחצו להאזנה לסיפור"})]})]}),t.jsxs("div",{className:"p-4 space-y-2",children:[t.jsx("h2",{className:"text-lg font-semibold",children:e.title}),e.excerpt&&t.jsx("p",{className:"text-sm text-gray-600 line-clamp-3",children:e.excerpt})]})]})},e.id)})}),S&&t.jsx("div",{className:"mt-6 text-center",children:t.jsx("button",{onClick:E,disabled:f,className:"px-4 py-2 rounded-lg border text-sm disabled:opacity-50",children:"טען עוד"})}),f&&o.length>0&&t.jsxs("div",{className:"mt-6 text-center flex justify-center items-center gap-2 text-gray-500",children:[t.jsx(z,{className:"w-5 h-5 animate-spin"}),t.jsx("span",{children:"טוען סיפורים נוספים..."})]})]})}export{F as Component};
