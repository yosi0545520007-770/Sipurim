import{r as u,j as e,s as f,H as L}from"./index-BaQbnNW9.js";import{D as ie}from"./react-datepicker-DZsISyGV.js";import{L as ce}from"./loader-circle-obG_XASh.js";import"./clsx-B-dksMZM.js";function G({ok:a}){return e.jsx("span",{className:a?"text-green-600":"text-red-500",children:a?"✓":"✗"})}function oe(a){return a instanceof Date&&!isNaN(a.getTime())}function q(a){const n=a?new Date(a):new Date;return oe(n)?n:new Date}function P(a){return a.normalize("NFD").replace(/[\u0591-\u05C7]/g,"").normalize("NFC")}function de(a){const n=["","א","ב","ג","ד","ה","ו","ז","ח","ט"],s=["","י","כ","ל","מ","נ","ס","ע","פ","צ"],g=["","ק","ר","ש","ת","תתק"],c=a%1e3,m=Math.floor(c/100);let o=Math.floor(c%100/10),x=c%10;o===1&&(x===5||x===6)&&(o=0,x=x===5?15:16);const j=x===15?"טו":x===16?"טז":n[x],d=(g[m]||"")+(s[o]||"")+j;return d.length>=2?d.slice(0,-1)+"״"+d.slice(-1):d+"׳"}function F(a){try{const n=q(a),s=new L(n);return typeof s.renderGematriya=="function"?s.renderGematriya():typeof s.render=="function"?s.render("he"):""}catch{return""}}function ue(a){try{const n=q(a),s=new L(n),g=typeof s.renderGematriya=="function"?String(s.renderGematriya()).split(" ")[0]:String(s.getDate&&s.getDate())||"";let c=s.getMonthName&&s.getMonthName("he")||"";(!c||/[A-Za-z]/.test(c))&&(c=(typeof s.render=="function"?String(s.render("he")).split(" "):[])[1]||"");const m=P(String(c));return{dayG:g,monthHe:m}}catch{return{dayG:"",monthHe:""}}}function me(a){const n=new L(a);let s=n.getMonthName&&n.getMonthName("he")||"";const g=P(String(s)),c=n.getFullYear&&n.getFullYear()||5785;return{month:g,year:de(c)}}const $="media";async function xe(a,n){const s=(a.name.split(".").pop()||"bin").toLowerCase(),c=`${s==="mp3"||s==="m4a"?"mp3":n}/${Date.now()}-${Math.random().toString(16).slice(2)}.${s}`,{error:m}=await f.storage.from($).upload(c,a,{upsert:!1,cacheControl:"3600",contentType:a.type||(["jpg","jpeg","png","gif","webp","avif"].includes(s)?`image/${s==="jpg"?"jpeg":s}`:s==="mp3"?"audio/mpeg":s==="m4a"?"audio/mp4":void 0)});if(m)throw m;const{data:o}=f.storage.from($).getPublicUrl(c);return o.publicUrl}const he=`
  .react-datepicker__day.has-story {
    background-color: #dcfce7; /* green-100 */
    color: #166534; /* green-800 */
    border-radius: 50%;
    font-weight: bold;
  }
`,k=new Map;function U(a){return P(String(a||"")).replace(/["'״׳]/g,"").replace(/\s+/g," ").trim()}function ge(a){const n=U(a);if(k.has(n))return k.get(n)||null;const s=new Date,g=s.getFullYear()-5,c=s.getFullYear()+2;for(let m=g;m<=c;m++){const o=new Date(m,0,1);for(;o.getFullYear()===m;){const x=U(F(o));if(x&&x===n){const j=new Date(o.getFullYear(),o.getMonth(),o.getDate());return k.set(n,j),j}o.setDate(o.getDate()+1)}}return k.set(n,null),null}function we(){const[a,n]=u.useState([]),[s,g]=u.useState([]),[c,m]=u.useState([]),[o,x]=u.useState(!0),[j,d]=u.useState(null),[Y,b]=u.useState(null),[v,_]=u.useState(!1),[B,N]=u.useState(!1),[M,z]=u.useState(null),[l,p]=u.useState({title:"",excerpt:"",image_url:"",audio_url:"",play_date:"",category_id:""});async function O(){try{const[{data:t},{data:r}]=await Promise.all([f.from("series").select("id, title").order("title"),f.from("categories").select("id, name").order("name")]);g(t||[]),m(r||[])}catch{d("שגיאה בטעינת סדרות וקטגוריות")}}async function D(){try{x(!0),d(null);const{data:t,error:r}=await f.from("stories").select("id,title,excerpt,image_url,audio_url,publish_at,play_date,updated_at,series_id,series_order,category_id").is("series_id",null).order("updated_at",{ascending:!1});if(r)throw r;n(t||[])}catch(t){d(t.message||"שגיאה בטעינת הסיפורים")}finally{x(!1)}}u.useEffect(()=>{O(),D()},[]);function R(){z(null),p({title:"",excerpt:"",image_url:"",audio_url:"",play_date:"",category_id:""}),N(!0)}function K(t){z(t.id),p({title:t.title||"",excerpt:t.excerpt||"",image_url:t.image_url||"",audio_url:t.audio_url||"",play_date:t.play_date||"",category_id:t.category_id||""}),N(!0)}const[V,w]=u.useState(!1),[Z,T]=u.useState(new Date),[E,H]=u.useState(""),J=u.useMemo(()=>{const t=new Set;a.forEach(i=>{i.play_date&&t.add(i.play_date)});const r=[];for(const i of Array.from(t))try{const h=new Date(i);if(!isNaN(h.getTime())){r.push(new Date(h.getFullYear(),h.getMonth(),h.getDate()));continue}}catch{}for(const i of Array.from(t)){const h=ge(String(i));h&&r.push(h)}return r},[a]),[y,S]=u.useState(new Set);function Q(){const t=new Date;T(t),H(F(t)),w(!0)}function W(){p(t=>({...t,play_date:E})),w(!1)}const X=async t=>{var i;const r=(i=t.target.files)==null?void 0:i[0];if(r)try{d(null),b(null),_(!0);const h=await xe(r,"images");p({...l,image_url:h}),b('התמונה הועלתה. יש ללחוץ על "שמירה" כדי לעדכן.')}catch(h){d(h.message||"שגיאת העלאת תמונה")}finally{_(!1),t.target.value=""}};async function ee(){try{if(d(null),b(null),_(!0),!l.title.trim())throw new Error("כותרת היא שדה חובה.");const t={title:l.title.trim(),excerpt:l.excerpt.trim()||null,image_url:l.image_url.trim()||null,audio_url:l.audio_url.trim()||null,play_date:l.play_date,category_id:l.category_id?l.category_id:null};if(M){const{error:r}=await f.from("stories").update(t).eq("id",M);if(r)throw r;b("הסיפור עודכן בהצלחה!")}else{const{error:r}=await f.from("stories").insert(t);if(r)throw r;b("הסיפור נוצר בהצלחה!")}N(!1),await D()}catch(t){d(t.message||"שגיאה בשמירת הסיפור")}finally{_(!1)}}const te=t=>{S(r=>{const i=new Set(r);return i.has(t)?i.delete(t):i.add(t),i})},ae=t=>{t.target.checked?S(new Set(a.map(r=>r.id))):S(new Set)},se=a.length>0&&y.size===a.length;async function re(t){if(confirm("האם למחוק את הסיפור?"))try{d(null);const{error:r}=await f.from("stories").delete().eq("id",t);if(r)throw r;b("הסיפור נמחק בהצלחה"),await D()}catch(r){d(r.message||"שגיאה במחיקת הסיפור")}}async function le(){if(y.size!==0&&confirm(`האם למחוק ${y.size} סיפורים נבחרים?`))try{d(null);const{error:t}=await f.from("stories").delete().in("id",Array.from(y));if(t)throw t;b(`${y.size} סיפורים נמחקו בהצלחה`),S(new Set),await D()}catch(t){d(t.message||"שגיאה במחיקה גורפת")}}return e.jsxs("section",{className:"p-6 space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"ניהול סיפורים"}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-xl",onClick:R,children:"+ סיפור חדש"})]}),j&&e.jsx("div",{className:"rounded-lg bg-red-50 text-red-700 p-3",children:j}),Y&&e.jsx("div",{className:"rounded-lg bg-green-50 text-green-700 p-3",children:Y}),o&&e.jsx("div",{children:"טוען רשימת סיפורים..."}),!o&&e.jsxs("div",{className:"rounded-2xl border overflow-x-auto bg-white",children:[y.size>0&&e.jsxs("div",{className:"p-2 bg-blue-50 border-b flex items-center gap-4",children:[e.jsxs("span",{className:"text-sm text-blue-800",children:[y.size," פריטים נבחרו"]}),e.jsx("button",{onClick:le,className:"px-3 py-1 rounded-lg border border-red-300 bg-red-50 text-red-600 text-sm",children:"מחק נבחרים"})]}),e.jsxs("table",{className:"w-full min-w-[800px] text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 w-10",children:e.jsx("input",{type:"checkbox",checked:se,onChange:ae,className:"rounded"})}),e.jsx("th",{className:"p-3 text-right",children:"כותרת"}),e.jsx("th",{className:"p-3 text-center",children:"תמונה"}),e.jsx("th",{className:"p-3 text-center",children:"שמע"}),e.jsx("th",{className:"p-3 text-right",children:"תאריך השמעה"}),e.jsx("th",{className:"p-3 text-right",children:"פעולות"})]})}),e.jsxs("tbody",{children:[a.map(t=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3 text-center",children:e.jsx("input",{type:"checkbox",checked:y.has(t.id),onChange:()=>te(t.id),className:"rounded"})}),e.jsxs("td",{className:"p-3 align-top",children:[e.jsx("div",{className:"font-medium",children:t.title}),t.excerpt&&e.jsx("div",{className:"text-xs text-gray-600 mt-1 line-clamp-2",children:t.excerpt})]}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(G,{ok:!!t.image_url})}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(G,{ok:!!t.audio_url})}),e.jsx("td",{className:"p-3",children:t.play_date||"—"}),e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex flex-wrap gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1 rounded-lg border",onClick:()=>K(t),children:"עריכה"}),e.jsx("button",{className:"px-3 py-1 rounded-lg border border-red-300 text-red-600",onClick:()=>re(t.id),children:"מחיקה"})]})})]},t.id)),a.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"p-3 text-gray-500",colSpan:6,children:"לא נמצאו סיפורים."})})]})]})]}),B&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 grid place-items-center p-4",onClick:()=>N(!1),children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6",onClick:t=>t.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:M?"עריכת סיפור":"סיפור חדש"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"כותרת *"}),e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:l.title,onChange:t=>p({...l,title:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"תקציר"}),e.jsx("textarea",{className:"w-full mt-1 border rounded-lg p-2 min-h-[100px]",value:l.excerpt,onChange:t=>p({...l,excerpt:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"כתובת תמונה"}),e.jsxs("div",{className:"flex items-center gap-4 mt-1",children:[l.image_url&&e.jsx("img",{src:l.image_url,alt:"תצוגה מקדימה",className:"w-16 h-16 rounded-lg object-cover border"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("input",{className:"w-full border rounded-lg p-2",placeholder:"הדבק URL או העלה קובץ",value:l.image_url,onChange:t=>p({...l,image_url:t.target.value})}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"או העלאה:"}),e.jsx("input",{type:"file",accept:"image/*",onChange:X,disabled:v,className:"text-sm"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"כתובת קובץ שמע"}),e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:l.audio_url,onChange:t=>p({...l,audio_url:t.target.value})}),l.audio_url&&e.jsx("audio",{controls:!0,src:l.audio_url,className:"w-full mt-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"תאריך השמעה (עברי)"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",placeholder:"לדוגמא: י״ד אלול תשפ״ה",value:l.play_date||"",onChange:t=>p({...l,play_date:t.target.value})}),e.jsx("button",{type:"button",className:"px-3 py-2 rounded-lg border",onClick:Q,children:"בחירה"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"קטגוריה"}),e.jsxs("select",{className:"w-full mt-1 border rounded-lg p-2 bg-white",value:l.category_id,onChange:t=>p({...l,category_id:t.target.value}),children:[e.jsx("option",{value:"",children:"— ללא —"}),c.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6 justify-end",children:[e.jsx("button",{className:"bg-gray-200 px-4 py-2 rounded-lg",onClick:()=>N(!1),disabled:v,children:"ביטול"}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg disabled:opacity-50",onClick:ee,disabled:v,children:v?e.jsx(ce,{className:"animate-spin"}):"שמירה"})]})]})}),V&&e.jsxs(e.Fragment,{children:[e.jsx("style",{children:he}),e.jsx("div",{className:"fixed inset-0 bg-black/30 grid place-items-center z-[60]",onClick:()=>w(!1),children:e.jsxs("div",{className:"bg-white rounded-2xl p-4 w-full max-w-md",onClick:t=>t.stopPropagation(),dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"בחר תאריך השמעה"}),e.jsx("button",{onClick:()=>w(!1),className:"text-gray-500",children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(ie,{selected:Z,onChange:t=>{T(t),H(F(t||new Date))},inline:!0,calendarStartDay:0,isClearable:!1,highlightDates:[{"has-story":J}],showPopperArrow:!1,renderCustomHeader:({date:t,decreaseMonth:r,increaseMonth:i,changeYear:h,changeMonth:pe})=>{const C=t;C.getFullYear(),C.getMonth();const ne=C.toLocaleDateString("he-IL",{month:"long",year:"numeric"}),I=me(C);return Array.from({length:12},(fe,A)=>({idx:A,label:new Date(2020,A,1).toLocaleDateString("he-IL",{month:"long"})})),e.jsxs("div",{className:"px-2 py-1",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",onClick:r,className:"px-2 text-lg",children:"‹"}),e.jsx("div",{className:"font-semibold",children:ne}),e.jsx("button",{type:"button",onClick:i,className:"px-2 text-lg",children:"›"})]}),e.jsxs("div",{className:"text-sm text-gray-600 text-center mt-1",children:[I.month," ",I.year]})]})},renderDayContents:(t,r)=>{const{dayG:i,monthHe:h}=ue(r);return e.jsxs("div",{className:"flex flex-col items-center leading-tight py-0.5",children:[e.jsx("span",{className:"text-[13px]",children:t}),e.jsx("span",{className:"text-[11px] opacity-80",children:i})]})}}),e.jsxs("div",{className:"rounded-lg border p-3 bg-gray-50",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-1",children:"תאריך נבחר (עברי):"}),e.jsx("div",{className:"font-medium",children:E||"—"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded-lg border",onClick:()=>w(!1),children:"ביטול"}),e.jsx("button",{className:"px-3 py-2 rounded-lg bg-blue-600 text-white",onClick:W,children:"בחר"})]})]})]})})]})]})}export{we as Component};
