import{r as d,s as B,j as e,l as P,h as X,i as W,H as U,k as ye}from"./index-B54MtHlO.js";import{D as be}from"./react-datepicker-CgkRkzsn.js";import"./clsx-B-dksMZM.js";function R(s){try{if(!s)return"";const r=typeof s=="string"?new Date(s):s;return isNaN(r.getTime())?"":new U(r).renderGematriya()}catch{return""}}function we(s){try{return(s||"").normalize("NFD").replace(/[\u0591-\u05C7]/g,"").normalize("NFC")}catch{return s||""}}function J(s){return we(String(s||"")).replace(/["'״׳]/g,"").replace(/\s+/g," ").trim()}function Z(s){const r=J(s);if(!r)return null;const m=new Date,u=m.getFullYear()-5,f=m.getFullYear()+2;for(let o=u;o<=f;o++){const x=new Date(o,0,1);for(;x.getFullYear()===o;){const g=J(R(x));if(g&&g===r)return new Date(x.getFullYear(),x.getMonth(),x.getDate());x.setDate(x.getDate()+1)}}return null}function l(s){let r=String(s??"").trim();return r=r.replace(/^\s*\[\s*"(.*)"\s*\]\s*$/s,"$1"),r=r.replace(/^\{"?(.*?)"?\}$/,"$1"),r=r.replace(/^["'\[\]]+|["'\[\]]+$/g,""),r=r.replace(/\s+/g," ").trim(),r}function K(s){const r=(s||"").trim();return r?["משה","שלמה","יהודה","אליה","אריה","ירמיה","נחמיה"].includes(r)?"male":["מרים","יעל","אסתר","מיכל","רות","חן","שירן","לירן","סיון","כרמל","שקד","הדס","אביגיל"].includes(r)||r.endsWith("ה")||r.endsWith("ת")?"female":"male":""}function ve(s){const r=new U(s),m=r.getMonthName("he"),u=r.getFullYear(),f=new Intl.NumberFormat("he-IL-u-nu-hebr",{useGrouping:!1}).format(u);return{monthName:m,hebrewYear:f}}function _e(s,r){const m=new U(r),u=new Intl.NumberFormat("he-IL-u-nu-hebr",{useGrouping:!1}).format(m.getDate());return e.jsxs("div",{className:"flex flex-col items-center leading-tight py-0.5",children:[e.jsx("span",{className:"text-[13px]",children:s}),e.jsx("span",{className:"text-[11px] opacity-80",children:u})]})}function Ee(){const[s,r]=d.useState([]),[m,u]=d.useState(!0),[f,o]=d.useState(null),[x,g]=d.useState(null),[q,k]=d.useState(!1),[F,i]=d.useState(null),[p,j]=d.useState(""),[v,h]=d.useState(""),[S,E]=d.useState(""),[H,w]=d.useState(""),[$,_]=d.useState(""),[C,D]=d.useState(null),[A,ee]=d.useState([]),[G,O]=d.useState(null),[M,Y]=d.useState({honoree:"",father_name:"",mother_name:""}),V=`
    .react-datepicker__day.has-story { background-color: #dcfce7; color: #166534; border-radius: 50%; font-weight: bold; }
  `;function te(){try{const t=["honoree","last_name","father_name","mother_name","gender","event_date"],n=s.map(I=>{const me=l(I.honoree),xe=l(I.last_name||""),fe=l(I.father_name||""),ge=l(I.mother_name||""),pe=I.gender||"",je=I.event_date||"";return[me,xe,fe,ge,pe,je].map(Ne=>{const z=String(Ne??"");return/[",\n]/.test(z)?'"'+z.replace(/"/g,'""')+'"':z}).join(",")}),a="\uFEFF",N=[t.join(","),...n].join(`
`),c=new Blob([a+N],{type:"text/csv;charset=utf-8;"}),y=URL.createObjectURL(c),b=document.createElement("a"),T=new Date,de=T.getFullYear(),ue=String(T.getMonth()+1).padStart(2,"0"),he=String(T.getDate()).padStart(2,"0");b.href=y,b.download=`memorials-${de}-${ue}-${he}.csv`,document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(y)}catch(t){console.error(t),alert("שגיאה ביצוא CSV")}}async function L(){try{u(!0),o(null);const{data:t,error:n}=await P();n&&console.error("Error fetching memorials, possibly due to malformed data:",n),r(t||[])}catch(t){o(t.message||"שגיאה בטעינת הנתונים")}finally{u(!1)}}d.useEffect(()=>{L()},[]),d.useEffect(()=>{(async()=>{try{const{data:t}=await B.from("stories").select("play_date").not("play_date","is",null),n=new Set;(t||[]).forEach(c=>{c.play_date&&n.add(String(c.play_date))});const a=[];for(const c of Array.from(n)){const y=new Date(c);if(!isNaN(y.getTime())){a.push(new Date(y.getFullYear(),y.getMonth(),y.getDate()));continue}const b=Z(c);b&&a.push(b)}const N=new Map;a.forEach(c=>N.set(`${c.getFullYear()}-${c.getMonth()}-${c.getDate()}`,c)),ee(Array.from(N.values()))}catch{}})()},[]);function ne(){i(null),j(""),h(""),E(""),w(""),_(""),D(null),k(!0)}function re(t){i(t.id);const n=l(t.honoree||""),a=l(t.last_name||""),N=l(t.father_name||""),c=l(t.mother_name||""),y=t.gender||"";E(N),j(n),w(c),h(a),_(y),D(t.event_date?new Date(t.event_date):null),k(!0)}function ae(t){O(t.id),Y({honoree:l(t.honoree||""),father_name:l(t.father_name||""),mother_name:l(t.mother_name||"")})}async function se(){const t=l(p);if(!t){o("יש למלא שם נזכר/ת");return}try{o(null);const n={honoree:t,last_name:l(v)||null,father_name:[l(S)||"אברהם"],mother_name:[l(H)||"שרה"],gender:$?[$]:null,event_date:C?C.toISOString().slice(0,10):null},{error:a}=F?await W(F,n):await X(n);if(a)throw new Error(a);g(`נשמר בהצלחה: ${t}`),k(!1),await L()}catch(n){o(n.message||"שגיאה בשמירה")}}async function le(){if(!G)return;const t=l(M.honoree);if(!t){o("שם הנזכר/ת לא יכול להיות ריק");return}try{o(null);const n={honoree:t,father_name:[l(M.father_name)||"אברהם"],mother_name:[l(M.mother_name)||"שרה"]},{error:a}=await W(G,n);if(a)throw new Error(a);g(`עודכן בהצלחה: ${t}`),O(null),await L()}catch(n){o(n.message||"שגיאה בעדכון")}}async function oe(t){if(confirm("למחוק את הרשומה?"))try{o(null);const{error:n}=await ye(t);if(n)throw new Error(n);g("נמחק בהצלחה"),await L()}catch(n){o(n.message||"שגיאה במחיקה")}}async function ce(){if(s.length===0){alert("אין רשומות למחיקה");return}if(confirm(`האם למחוק את כל ${s.length} הנפטרים? פעולה זו בלתי הפיכה.`))try{o(null);const t=s.map(a=>a.id),{error:n}=await B.from("memorials").delete().in("id",t);if(n)throw n;g(`נמחקו ${t.length} רשומות בהצלחה`),await L()}catch(t){o(t.message||"שגיאה במחיקה הגלובאלית")}}async function ie(){if(confirm("האם לעדכן אוטומטית את המין עבור כל הרשומות שבהן הוא חסר? הפעולה תתבצע רק על רשומות ללא מין מוגדר."))try{u(!0),o(null);const{data:t,error:n}=await P();if(n)throw n;if(!t||t.length===0){alert("אין רשומות לעדכון.");return}const a=[];for(const c of t)if(!c.gender){const y=l(c.honoree||"").split(" ")[0],b=K(y);b&&a.push({...c,gender:[b]})}if(a.length===0){g("לא נמצאו רשומות לעדכון. נראה שהכל כבר מעודכן.");return}const{error:N}=await B.from("memorials").upsert(a);if(N)throw N;g(`עודכנו ${a.length} רשומות בהצלחה.`),await L()}catch(t){o(t.message||"שגיאה בעדכון המין ההמוני")}finally{u(!1)}}return e.jsxs("section",{className:"p-6 space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"לעילוי נשמת (ניהול)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border",onClick:()=>{var t;return(t=Q.current)==null?void 0:t.click()},children:"ייבוא CSV"}),e.jsx("button",{className:"px-4 py-2 rounded-lg border border-red-300 text-red-600",onClick:ce,children:"מחיקה גלובאלית"}),e.jsx("button",{className:"px-4 py-2 rounded-lg border",onClick:ie,children:"עדכון מין (אוטומטי)"}),e.jsx("button",{className:"px-4 py-2 rounded-lg border",onClick:te,children:"ייצוא CSV"}),e.jsx("input",{ref:Q,type:"file",accept:".csv,text/csv",className:"hidden",onChange:Ce}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-blue-600 text-white",onClick:ne,children:"הוספת רשומה"})]})]}),f&&e.jsx("div",{className:"bg-red-50 text-red-700 p-3 rounded",children:f}),x&&e.jsx("div",{className:"bg-green-50 text-green-700 p-3 rounded",children:x}),m?e.jsx("div",{className:"text-gray-500",children:"טוען…"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full border rounded-2xl overflow-hidden",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 text-right",children:"שם"}),e.jsx("th",{className:"p-3 text-right",children:"שם האב"}),e.jsx("th",{className:"p-3 text-right",children:"שם האם"}),e.jsx("th",{className:"p-3 text-right",children:"מין"}),e.jsx("th",{className:"p-3 text-right",children:"תאריך פטירה"}),e.jsx("th",{className:"p-3 text-right"})]})}),e.jsxs("tbody",{children:[s.map(t=>G===t.id?e.jsxs("tr",{className:"border-t bg-blue-50",children:[e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"text",className:"w-full p-1 border rounded",value:M.honoree,onChange:n=>Y(a=>({...a,honoree:n.target.value}))})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"text",className:"w-full p-1 border rounded",value:M.father_name,onChange:n=>Y(a=>({...a,father_name:n.target.value}))})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"text",className:"w-full p-1 border rounded",value:M.mother_name,onChange:n=>Y(a=>({...a,mother_name:n.target.value}))})}),e.jsx("td",{className:"p-3 text-gray-500 text-xs",colSpan:2,children:"עריכה מהירה..."}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex flex-wrap gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1 rounded-lg bg-blue-600 text-white",onClick:le,children:"שמור"}),e.jsx("button",{className:"px-3 py-1 rounded-lg border",onClick:()=>O(null),children:"ביטול"})]})})]},`${t.id}-edit`):e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3 font-medium",children:l(t.honoree)}),e.jsx("td",{className:"p-3",children:l(t.father_name||"")||"—"}),e.jsx("td",{className:"p-3",children:l(t.mother_name||"")||"—"}),e.jsx("td",{className:"p-3",children:t.gender==="male"?"גבר":t.gender==="female"?"אישה":"—"}),e.jsx("td",{className:"p-3",children:t.event_date?R(t.event_date):"—"}),e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex flex-wrap gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1 rounded-lg border",onClick:()=>ae(t),children:"עריכה מהירה"}),e.jsx("button",{className:"px-3 py-1 rounded-lg border",onClick:()=>re(t),children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-more-horizontal",children:[e.jsx("circle",{cx:"12",cy:"12",r:"1"}),e.jsx("circle",{cx:"19",cy:"12",r:"1"}),e.jsx("circle",{cx:"5",cy:"12",r:"1"})]})}),e.jsx("button",{className:"px-3 py-1 rounded-lg border border-red-300 text-red-600",onClick:()=>oe(t.id),children:"מחיקה"})]})})]},t.id)),s.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"p-3 text-gray-500",colSpan:6,children:"אין נתונים להצגה."})})]})]})}),q&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 grid place-items-center p-4",onClick:()=>k(!1),children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-6",onClick:t=>t.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:F?"עריכת רשומה":"רשומה חדשה"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"שם נזכר/ת *"}),e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:p,onChange:t=>j(t.target.value),onBlur:t=>{const n=l(t.target.value);j(n);const a=K(n.split(" ")[0]);a&&_(a)}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"שם משפחה"}),e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:v,onChange:t=>h(t.target.value),onBlur:t=>h(l(t.target.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"שם האב"}),e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:S,onChange:t=>E(t.target.value),onBlur:t=>E(l(t.target.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"שם האם"}),e.jsx("input",{className:"w-full mt-1 border rounded-lg p-2",value:H,onChange:t=>w(t.target.value),onBlur:t=>w(l(t.target.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"מין"}),e.jsxs("select",{className:"w-full mt-1 border rounded-lg p-2 bg-white",value:$,onChange:t=>_(t.target.value),children:[e.jsx("option",{value:"",children:"לא צוין"}),e.jsx("option",{value:"male",children:"גבר"}),e.jsx("option",{value:"female",children:"אישה"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-600",children:"תאריך פטירה"}),e.jsx("style",{children:V}),e.jsx("style",{children:V}),e.jsx(be,{selected:C,onChange:t=>D(t),inline:!0,showPopperArrow:!1,className:"w-full mt-1 border rounded-lg p-2 text-right",calendarStartDay:0,highlightDates:[{"has-story":A}],highlightDates:[{"has-story":A}],renderCustomHeader:({date:t,decreaseMonth:n,increaseMonth:a})=>{const{monthName:N,hebrewYear:c}=ve(t);return e.jsxs("div",{className:"flex items-center justify-between px-2 py-1",children:[e.jsx("button",{type:"button",onClick:n,className:"px-2 text-lg",children:"‹"}),e.jsxs("div",{className:"font-semibold",children:[N," ",c]}),e.jsx("button",{type:"button",onClick:a,className:"px-2 text-lg",children:"›"})]})},renderDayContents:_e}),e.jsx("button",{type:"button",className:"text-sm text-blue-600 hover:underline mt-1",onClick:()=>D(null),children:"נקה תאריך"}),C&&e.jsxs("div",{className:"mt-1 text-sm text-gray-600",children:["עברי: ",R(C)]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6 justify-end",children:[e.jsx("button",{className:"bg-gray-200 px-4 py-2 rounded-lg",onClick:()=>k(!1),children:"ביטול"}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg",onClick:se,children:"שמור"})]})]})})]})}const Q={current:null};async function Ce(s){var m;const r=(m=s.target.files)==null?void 0:m[0];if(r)try{const f=(await r.text()).split(/\r?\n/).filter(i=>i.trim()!=="");if(f.length===0)return;const o=i=>{const p=[];let j="",v=!1;for(let h=0;h<i.length;h++){const S=i[h];if(S==='"'){v=!v;continue}if(S===","&&!v){p.push(j),j="";continue}j+=S}return p.push(j),p.map(h=>h.trim())},x=["honoree","father_name","mother_name","gender","event_date"],g=o(f[0]).map(i=>i.toLowerCase()),F=(x.some(i=>g.includes(i))?f.slice(1):f).map(o).map(i=>{const[p,j,v,h,S]=i,E=l(p),H=l(j),w=(v||"").toLowerCase(),$=w==="male"||w==="זכר"?"male":w==="female"||w==="נקבה"?"female":null;let _=null;if(h){const C=new Date(h);if(!isNaN(C.getTime()))_=C.toISOString().slice(0,10);else{const D=Z(h);D&&(_=D.toISOString().slice(0,10))}}return{honoree:E,father_name:H?[H]:null,gender:$?[$]:null,event_date:_}}).filter(i=>i.honoree);for(const i of F){const{error:p}=await X(i);if(p)throw new Error(p)}alert(`יובאו ${F.length} נפטרים בהצלחה`),s.target.value=""}catch(u){alert(u.message||"שגיאה בייבוא CSV")}}export{Ee as Component};
