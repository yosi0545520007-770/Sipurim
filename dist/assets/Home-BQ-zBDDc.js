import{u as E,a as $,r as i,s as m,j as e,H as k}from"./index-DhAAA4kQ.js";function A(){try{const l=new k(new Date);if(typeof l.renderGematriya=="function")return l.renderGematriya();if(typeof l.render=="function")return l.render("he");const d=new Date;return`${d.getDate()} ${d.toLocaleString("he-IL",{month:"long"})} ${d.getFullYear()}`}catch{return""}}function H(){const l=E(),{isHeard:d}=$(),[s,u]=i.useState(null),[w,j]=i.useState([]),[p,L]=i.useState(""),[h,x]=i.useState(!0),[f,y]=i.useState(null),[g,N]=i.useState(!1),[v,_]=i.useState(typeof Notification<"u"?Notification.permission==="granted":!1),[M,D]=i.useState(!1);i.useEffect(()=>{N(typeof window<"u"&&"serviceWorker"in navigator&&"PushManager"in window)},[]),i.useEffect(()=>{(async()=>{try{x(!0),y(null);const{data:t,error:r}=await m.from("stories").select("id,title,excerpt,image_url,audio_url,play_date").is("series_id",null).eq("play_date",A()).order("play_date",{ascending:!1}).limit(1).maybeSingle();if(r)throw r;if(t)u(t);else{const{data:o,error:c}=await m.from("stories").select("id,title,excerpt,image_url,audio_url,play_date").is("series_id",null);if(c)throw c;if(o&&o.length>0){const C=o[Math.floor(Math.random()*o.length)];u(C)}else u(null)}const{data:n,error:a}=await m.from("stories").select("id,title,excerpt,image_url,audio_url,play_date,publish_at").order("publish_at",{ascending:!1}).limit(200);if(a)throw a;j(n||[])}catch(t){y(t.message||"שגיאה בטעינה")}finally{x(!1)}})()},[]);function S(t){const r="=".repeat((4-t.length%4)%4),n=(t+r).replace(/-/g,"+").replace(/_/g,"/"),a=atob(n),o=new Uint8Array(a.length);for(let c=0;c<a.length;++c)o[c]=a.charCodeAt(c);return o}async function P(){try{if(!g){alert("הדפדפן לא תומך בהתראות פוש");return}const t=await navigator.serviceWorker.register("/sw.js");if(await Notification.requestPermission()!=="granted")return;_(!0);const n=void 0;if(!n){alert("חסר VITE_VAPID_PUBLIC_KEY בקובץ .env.local");return}const a=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:S(n)});await fetch("/api/save-subscription",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),alert("נרשמת לקבלת עדכונים!")}catch(t){console.error(t),alert(t.message||"שגיאה בהרשמה לפוש")}}const b=p.trim()?w.filter(t=>{const r=p.toLowerCase();return t.title.toLowerCase().includes(r)||(t.excerpt||"").toLowerCase().includes(r)}):[];return e.jsxs("section",{className:"p-6 max-w-6xl mx-auto",dir:"rtl",children:[f&&e.jsx("div",{className:"bg-red-50 text-red-700 p-3 rounded mb-4",children:f}),h&&e.jsx("div",{className:"text-gray-500",children:"טוען…"}),!h&&!s&&e.jsx("div",{className:"text-gray-500",children:"אין סיפורים להצגה."}),s&&e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6 lg:gap-8 items-start bg-white border rounded-2xl overflow-hidden shadow-sm p-4 mb-10",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative aspect-video",children:[s.image_url?e.jsx("img",{src:s.image_url,alt:s.title,className:"w-full rounded-lg object-cover"}):e.jsx("div",{className:"w-full h-48 bg-gray-100 grid place-items-center text-gray-400",children:"��� �����"}),s.audio_url&&(()=>{var r;return((r=l.current)==null?void 0:r.id)===s.id&&l.playing?null:e.jsx("button",{className:"absolute inset-0 grid place-items-center",onClick:()=>l.playTrack({id:s.id,title:s.title,audio_url:s.audio_url}),"aria-label":"��� �����",title:"����",children:e.jsxs("span",{className:"w-14 h-14 rounded-full bg-gray-800/60 text-white backdrop-blur flex items-center justify-center",children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-7 h-7","aria-hidden":"true",children:e.jsx("path",{d:"M8 5v14l11-7z"})}),e.jsx("span",{className:"sr-only",children:"����"})]})})})()]}),e.jsx("a",{href:`https://wa.me/?text=${encodeURIComponent(`📖 ${s.title}
${window.location.origin}/stories/${s.id}`)}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 text-green-600 hover:underline text-sm",children:"שתף ב־WhatsApp"}),e.jsx("div",{children:v?e.jsx("span",{className:"text-xs text-green-600",children:"✓ רשום לקבלת עדכונים"}):e.jsx("button",{onClick:P,className:"mt-1 bg-blue-600 text-white px-3 py-2 rounded-lg text-sm disabled:opacity-50",disabled:!g,title:g?"":"הדפדפן לא תומך בהתראות פוש",children:"קבל עדכונים (פוש)"})})]}),e.jsxs("div",{className:"flex flex-col justify-center",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:s.title}),s.excerpt?e.jsx("p",{className:"text-gray-700 leading-relaxed",children:s.excerpt}):e.jsx("p",{className:"text-gray-400",children:"אין תקציר זמין."})]})]}),p.trim()&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"תוצאות חיפוש"}),b.length>0?e.jsx("div",{className:"grid gap-6 sm:grid-cols-2 lg:grid-cols-3",children:b.map(t=>{const r=l.getProgress(t.id),n=!!r&&(r.pos||0)>0,a=!!r&&r.dur>0&&r.pos>=r.dur-2||d(t.id);return e.jsxs("article",{className:"relative rounded-2xl border bg-white overflow-hidden shadow-sm",children:[(a||n)&&e.jsx("span",{className:`absolute top-2 right-2 text-[11px] px-2 py-0.5 rounded-full ${a?"bg-green-600 text-white":"bg-blue-600 text-white"}`,children:"שמעתי"}),e.jsx("img",{src:t.image_url||"/logo.png",alt:t.title,className:"w-full h-40 object-cover"}),e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsx("h3",{className:"text-base font-semibold",children:t.title}),t.excerpt&&e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:t.excerpt})]})]},t.id)})}):e.jsx("p",{className:"text-gray-500",children:"לא נמצאו סיפורים התואמים לחיפוש."})]})]})}export{H as Component};
