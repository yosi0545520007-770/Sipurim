{"version":3,"file":"candles.js","sources":["../../../src/candles.ts"],"sourcesContent":["/* eslint-disable max-len */\nimport {HDate, months} from '@hebcal/hdate';\nimport {CalOptions} from './CalOptions';\nimport {Location} from './location';\nimport {Event, flags} from './event';\nimport {ChanukahEvent, HolidayEvent} from './HolidayEvent';\nimport {Zmanim} from './zmanim';\nimport {TimedEvent, CandleLightingEvent, HavdalahEvent} from './TimedEvent';\n\nconst LIGHT_CANDLES = flags.LIGHT_CANDLES;\nconst LIGHT_CANDLES_TZEIS = flags.LIGHT_CANDLES_TZEIS;\n\n/**\n * @private\n */\nexport function makeCandleEvent(\n  ev: Event | undefined,\n  hd: HDate,\n  options: CalOptions,\n  isFriday: boolean,\n  isSaturday: boolean\n): TimedEvent | undefined {\n  let havdalahTitle = false;\n  let useHavdalahOffset = isSaturday;\n  let mask = ev ? ev.getFlags() : LIGHT_CANDLES;\n  if (typeof ev !== 'undefined') {\n    // if linked event && dow == FRI, use Candle lighting time & title\n    if (!isFriday) {\n      if (mask & (LIGHT_CANDLES_TZEIS | flags.CHANUKAH_CANDLES)) {\n        useHavdalahOffset = true;\n      } else if (mask & flags.YOM_TOV_ENDS) {\n        havdalahTitle = true;\n        useHavdalahOffset = true;\n      }\n    }\n  } else if (isSaturday) {\n    havdalahTitle = true;\n    mask = LIGHT_CANDLES_TZEIS;\n  }\n  // if Havdalah offset is 0 or undefined, we'll use tzeit time\n  const offset = useHavdalahOffset\n    ? Number(options.havdalahMins)\n    : Number(options.candleLightingMins);\n  const location = options.location as Location;\n  const useElevation = Boolean(options.useElevation);\n  const zmanim = new Zmanim(location, hd, useElevation);\n  const time =\n    useHavdalahOffset && !offset\n      ? zmanim.tzeit(options.havdalahDeg)\n      : zmanim.sunsetOffset(offset, true);\n  if (isNaN(time.getTime())) {\n    return undefined; // no sunset\n  }\n  if (havdalahTitle) {\n    return new HavdalahEvent(\n      hd,\n      mask,\n      time,\n      location,\n      options.havdalahMins,\n      ev,\n      options\n    );\n  } else {\n    mask |= LIGHT_CANDLES;\n    return new CandleLightingEvent(hd, mask, time, location, ev, options);\n  }\n}\n\nconst FAST_BEGINS = 'Fast begins';\nconst FAST_ENDS = 'Fast ends';\n\n/** A fast day also contains a start and end time */\nexport class FastDayEvent extends HolidayEvent {\n  /** original event */\n  readonly linkedEvent: HolidayEvent;\n  /** this will be a \"Fast begins\" event */\n  readonly startEvent?: TimedEvent;\n  /** this will be a \"Fast ends\" event */\n  readonly endEvent?: TimedEvent;\n  constructor(\n    linkedEvent: HolidayEvent,\n    startEvent?: TimedEvent,\n    endEvent?: TimedEvent\n  ) {\n    super(linkedEvent.getDate(), linkedEvent.getDesc(), linkedEvent.getFlags());\n    this.linkedEvent = linkedEvent;\n    this.startEvent = startEvent;\n    this.endEvent = endEvent;\n  }\n  render(locale?: string): string {\n    return this.linkedEvent.render(locale);\n  }\n  renderBrief(locale?: string): string {\n    return this.linkedEvent.renderBrief(locale);\n  }\n  urlDateSuffix(): string {\n    return this.linkedEvent.urlDateSuffix();\n  }\n  url(): string | undefined {\n    return this.linkedEvent.url();\n  }\n  getEmoji(): string {\n    return this.linkedEvent.getEmoji();\n  }\n  getCategories(): string[] {\n    return this.linkedEvent.getCategories();\n  }\n}\n\n/**\n * Makes a pair of events representing fast start and end times\n * @private\n */\nexport function makeFastStartEnd(\n  ev: HolidayEvent,\n  options: CalOptions\n): FastDayEvent {\n  const desc = ev.getDesc();\n  if (desc === 'Yom Kippur') {\n    throw new RangeError('YK does not require this function');\n  }\n  const hd = ev.getDate();\n  const dt = hd.greg();\n  const location = options.location as Location;\n  const fastEndDeg = options.fastEndDeg;\n  const useElevation = Boolean(options.useElevation);\n  const zmanim = new Zmanim(location, dt, useElevation);\n  let startEvent;\n  let endEvent;\n  if (desc === \"Erev Tish'a B'Av\") {\n    const sunset = zmanim.sunset();\n    if (!isNaN(sunset.getTime())) {\n      startEvent = makeTimedEvent(ev, sunset, FAST_BEGINS, options);\n    }\n  } else if (desc.startsWith(\"Tish'a B'Av\")) {\n    const tzeit = zmanim.tzeit(fastEndDeg);\n    if (!isNaN(tzeit.getTime())) {\n      endEvent = makeTimedEvent(ev, tzeit, FAST_ENDS, options);\n    }\n  } else {\n    const dawn = zmanim.alotHaShachar();\n    if (!isNaN(dawn.getTime())) {\n      startEvent = makeTimedEvent(ev, dawn, FAST_BEGINS, options);\n    }\n    if (\n      dt.getDay() !== 5 &&\n      !(hd.getDate() === 14 && hd.getMonth() === months.NISAN)\n    ) {\n      const tzeit = zmanim.tzeit(fastEndDeg);\n      if (!isNaN(tzeit.getTime())) {\n        endEvent = makeTimedEvent(ev, tzeit, FAST_ENDS, options);\n      }\n    }\n  }\n  const ev2 = new FastDayEvent(ev, startEvent, endEvent);\n  // copy properties such as memo or emoji\n  Object.assign(ev2, ev);\n  return ev2;\n}\n\n/**\n * @private\n */\nfunction makeTimedEvent(\n  ev: Event,\n  time: Date,\n  desc: string,\n  options: CalOptions\n): TimedEvent {\n  const location = options.location as Location;\n  const hd = ev.getDate();\n  return new TimedEvent(hd, desc, ev.getFlags(), time, location, ev, options);\n}\n\nexport class TimedChanukahEvent extends ChanukahEvent {\n  eventTime: Date;\n  eventTimeStr: string;\n  readonly location: Location;\n  constructor(\n    date: HDate,\n    desc: string,\n    mask: number,\n    eventTime: Date,\n    location: Location\n  ) {\n    super(date, desc, mask);\n    this.eventTime = Zmanim.roundTime(eventTime);\n    const timeFormat = location.getTimeFormatter();\n    this.eventTimeStr = Zmanim.formatTime(this.eventTime, timeFormat);\n    this.location = location;\n  }\n}\n\n/**\n * Makes a candle-lighting event for Chankah (not on Friday/Saturday).\n * At one point this used civil dusk (6 degrees below horizon).\n * Another source suggests 4.6667 degrees below horizon.\n * @private\n */\nexport function makeWeekdayChanukahCandleLighting(\n  ev: HolidayEvent,\n  hd: HDate,\n  options: CalOptions\n): TimedChanukahEvent | null {\n  const location = options.location as Location;\n  const useElevation = Boolean(options.useElevation);\n  const zmanim = new Zmanim(location, hd.greg(), useElevation);\n  const candleLightingTime = zmanim.beinHaShmashos();\n  if (isNaN(candleLightingTime.getTime())) {\n    return null;\n  }\n  const ev2 = new TimedChanukahEvent(\n    hd,\n    ev.getDesc(),\n    ev.getFlags(),\n    candleLightingTime,\n    location\n  );\n  ev2.emoji = ev.emoji;\n  ev2.chanukahDay = ev.chanukahDay;\n  return ev2;\n}\n"],"names":[],"mappings":"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"}